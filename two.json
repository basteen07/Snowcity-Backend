{
  "info": {
    "name": "SnowCity PayPhi End-to-End",
    "_postman_id": "coll-snowcity-payphi-e2e-001",
    "description": "Login → Create booking → Initiate PayPhi → Complete on PG → Check status",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "Payments Health (PayPhi only)",
      "request": {
        "method": "GET",
        "header": [],
        "url": "{{BASE_URL}}/api/payments/health"
      }
    },
    {
      "name": "Login (Admin)",
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "var j={}; try{ j = pm.response.json(); }catch(e){}",
              "var token = (j && j.token) || (j && j.data && j.data.token);",
              "if(token){ pm.environment.set('TOKEN', token); }",
              "var uid = (j && j.user && (j.user.user_id || j.user.id)) || j.user_id || (j && j.data && (j.data.user_id || (j.data.user && (j.data.user.user_id || j.data.user.id))));",
              "if(uid){ pm.environment.set('USER_ID', String(uid)); }",
              "pm.test('Got token', function(){ pm.expect(!!pm.environment.get('TOKEN')).to.eql(true); });"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          { "key": "Content-Type", "value": "application/json" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"email\": \"{{ADMIN_EMAIL}}\",\n  \"password\": \"{{ADMIN_PASSWORD}}\"\n}"
        },
        "url": "{{BASE_URL}}/api/auth/login"
      }
    },
    {
      "name": "List Attractions (choose ATTRACTION_ID)",
      "request": {
        "method": "GET",
        "header": [],
        "url": "{{BASE_URL}}/api/attractions"
      }
    },
    {
      "name": "List Slots (for ATTRACTION_ID + BOOKING_DATE)",
      "request": {
        "method": "GET",
        "header": [],
        "url": "{{BASE_URL}}/api/slots?attraction_id={{ATTRACTION_ID}}&date={{BOOKING_DATE}}"
      }
    },
    {
      "name": "Create Booking (Admin, owned by current user)",
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "var j={}; try{ j = pm.response.json(); }catch(e){}",
              "var id = j.booking_id || (j.data && j.data.booking_id) || j.id || (j.data && j.data.id);",
              "if(id){ pm.environment.set('BOOKING_ID', String(id)); }",
              "pm.test('Got BOOKING_ID', function(){ pm.expect(!!pm.environment.get('BOOKING_ID')).to.eql(true); });"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          { "key": "Authorization", "value": "Bearer {{TOKEN}}" },
          { "key": "Content-Type", "value": "application/json" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"user_id\": {{USER_ID}},\n  \"attraction_id\": {{ATTRACTION_ID}},\n  \"slot_id\": {{SLOT_ID}},\n  \"booking_date\": \"{{BOOKING_DATE}}\",\n  \"addons\": [],\n  \"payment_mode\": \"Online\",\n  \"markPaid\": false\n}"
        },
        "url": "{{BASE_URL}}/api/admin/bookings"
      }
    },
    {
      "name": "Initiate PayPhi (User-owned booking)",
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "var j={}; try{ j = pm.response.json(); }catch(e){}",
              "var url = j.redirectUrl || (j.data && j.data.redirectUrl);",
              "var ctx = j.tranCtx || (j.data && j.data.tranCtx) || (j.response && j.response.tranCtx);",
              "if(url){ pm.environment.set('REDIRECT_URL', url); }",
              "if(ctx){ pm.environment.set('TRAN_CTX', ctx); }",
              "pm.test('Got redirectUrl', function(){ pm.expect(!!pm.environment.get('REDIRECT_URL')).to.eql(true); });"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          { "key": "Authorization", "value": "Bearer {{TOKEN}}" },
          { "key": "Content-Type", "value": "application/json" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"email\": \"{{PAY_EMAIL}}\",\n  \"mobile\": \"{{PAY_MOBILE}}\"\n}"
        },
        "url": "{{BASE_URL}}/api/bookings/{{BOOKING_ID}}/pay/payphi/initiate"
      }
    },
    {
      "name": "PayPhi Status (User)",
      "request": {
        "method": "GET",
        "header": [
          { "key": "Authorization", "value": "Bearer {{TOKEN}}" }
        ],
        "url": "{{BASE_URL}}/api/bookings/{{BOOKING_ID}}/pay/payphi/status"
      }
    },
    {
      "name": "Admin: PayPhi Status (optional)",
      "request": {
        "method": "GET",
        "header": [
          { "key": "Authorization", "value": "Bearer {{TOKEN}}" }
        ],
        "url": "{{BASE_URL}}/api/admin/bookings/{{BOOKING_ID}}/pay/payphi/status"
      }
    },
    {
      "name": "Admin: Get Booking (verify payment_status)",
      "request": {
        "method": "GET",
        "header": [
          { "key": "Authorization", "value": "Bearer {{TOKEN}}" }
        ],
        "url": "{{BASE_URL}}/api/admin/bookings/{{BOOKING_ID}}"
      }
    }
  ]
}